<!-- 將此文件放在 Hugo 的 layouts/partials/bunny-animation.html -->
<!-- 整合版：結合開關控制 + 優雅的翻轉邏輯 -->

<div class="bunny" id="reading-bunny" style="display: none;">
    <img src="/images/mao_3.png" alt="bunny">
</div>

<style>
    .bunny {
        position: fixed;
        cursor: pointer;
        user-select: none;
        z-index: 9999;
        pointer-events: auto;
        filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3));
        transition: transform 0.1s ease;
    }

    .bunny img {
        width: 60px;
        height: auto;
        display: block;
    }

    .bunny.flipped img {
        transform: scaleX(-1);
    }

    @media (max-width: 768px) {
        .bunny img {
            width: 40px;
        }
    }
</style>

<script>
(function() {
    const bunny = document.getElementById('reading-bunny');
    if (!bunny) return;

    let isActive = false;  // 預設關閉（配合 header 按鈕）
    let animationFrameId = null;

    // DVD logo 風格設定
    let x = Math.random() * (window.innerWidth - 100);
    let y = Math.random() * (window.innerHeight - 100);
    let speedX = 2;
    let speedY = 2;
    let directionX = Math.random() > 0.5 ? 1 : -1;
    let directionY = Math.random() > 0.5 ? 1 : -1;
    
    const bunnySize = 60;

    // 初始位置
    bunny.style.left = x + 'px';
    bunny.style.top = y + 'px';

    // 初始隨機翻轉
    if (Math.random() > 0.5) {
        bunny.classList.add('flipped');
    }

    // 翻轉函式（使用 toggle，更簡潔）
    function flipBunny() {
        bunny.classList.toggle('flipped');
    }

    // 動畫函數
    function animate() {
        if (!isActive) return;

        let hasCollision = false;  // 使用旗標避免多次翻轉

        // 更新位置
        x += speedX * directionX;
        y += speedY * directionY;

        // 檢測左右邊界
        if (x <= 0) {
            x = 0;
            directionX = 1;
            hasCollision = true;
        } else if (x >= window.innerWidth - bunnySize) {
            x = window.innerWidth - bunnySize;
            directionX = -1;
            hasCollision = true;
        }

        // 檢測上下邊界
        if (y <= 0) {
            y = 0;
            directionY = 1;
            hasCollision = true;
        } else if (y >= window.innerHeight - bunnySize) {
            y = window.innerHeight - bunnySize;
            directionY = -1;
            hasCollision = true;
        }

        // 只要有碰撞就翻轉一次
        if (hasCollision) {
            flipBunny();
        }

        // 更新位置
        bunny.style.left = x + 'px';
        bunny.style.top = y + 'px';

        animationFrameId = requestAnimationFrame(animate);
    }

    // 開關動畫函數（給 header 按鈕呼叫）
    window.toggleBunnyAnimation = function() {
        isActive = !isActive;
        
        if (isActive) {
            bunny.style.display = 'block';
            animate();
        } else {
            bunny.style.display = 'none';
            if (animationFrameId) {
                cancelAnimationFrame(animationFrameId);
            }
        }
        
        return isActive;
    };

    // 點擊兔子改變方向並翻轉
    bunny.addEventListener('click', (e) => {
        e.preventDefault();
        e.stopPropagation();
        directionX *= -1;
        directionY *= -1;
        flipBunny();
    });

    // 視窗大小改變時調整位置
    window.addEventListener('resize', () => {
        if (x > window.innerWidth - bunnySize) {
            x = window.innerWidth - bunnySize;
        }
        if (y > window.innerHeight - bunnySize) {
            y = window.innerHeight - bunnySize;
        }
    });
})();
</script>
