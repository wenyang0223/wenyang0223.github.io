<section id="related-posts-section" class="related-wrapper" style="display:none; margin: 2rem 0; padding: 1.2rem; background: #f8f9fa; border-radius: 10px; border: 1px solid #e0e0e0;">
    <h3 style="margin-top:0; margin-bottom: 0.8rem; font-size: 0.95rem; color: #555; font-weight: 600;">üí° Âª∂‰º∏Èñ±ËÆÄ</h3>
    <div id="related-posts-list" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 0.8rem;"></div>
  </section>
  
  <script>
    document.addEventListener('DOMContentLoaded', async () => {
        const list = document.getElementById('related-posts-list');
        const section = document.getElementById('related-posts-section');
        const currentUrl = window.location.pathname;
        
        // Ë¶èÁØÑÂåñ URL(decode + ÁßªÈô§ÁµêÂ∞æÊñúÁ∑ö + Áµ±‰∏ÄÂ∞èÂØ´)
        const normalizeUrl = (url) => {
            if (!url) return '';
            try {
                // ÂÖà decode ËôïÁêÜ URL Á∑®Á¢º
                const decoded = decodeURIComponent(url);
                return decoded.replace(/\/$/, '').toLowerCase();
            } catch (e) {
                // Â¶ÇÊûú decode Â§±Êïó,Â∞±Áõ¥Êé•ËôïÁêÜ
                return url.replace(/\/$/, '').toLowerCase();
            }
        };
        
        const currentNormalizedUrl = normalizeUrl(currentUrl);
        
        console.log("üìç Áï∂ÂâçÈ†ÅÈù¢ URL:", currentUrl);
        console.log("üìç Ë¶èÁØÑÂåñ URL:", currentNormalizedUrl);
  
        // üîí Âä†Âº∑ÁâàÔºöÂà§Êñ∑ÊòØÂê¶ÁÇ∫Áï∂ÂâçÈ†ÅÈù¢ (‰∏âÈáçÊ™¢Êü•)
        const isCurrentPage = (pageUrl) => {
            if (!pageUrl) return false;

            // ÂÖà decode ÂÜçË¶èÁØÑÂåñ
            let normPage, normCurrent;
            try {
                normPage = decodeURIComponent(normalizeUrl(pageUrl)).replace(/\/index\.html?$/, '');
                normCurrent = decodeURIComponent(currentNormalizedUrl).replace(/\/index\.html?$/, '');
            } catch (e) {
                normPage = normalizeUrl(pageUrl).replace(/\/index\.html?$/, '');
                normCurrent = currentNormalizedUrl.replace(/\/index\.html?$/, '');
            }

            // ÊñπÊ≥ï1ÔºöË¶èÁØÑÂåñÂæåÂÆåÊï¥ÊØîÂ∞ç
            if (normPage === normCurrent) {
                return true;
            }

            // ÊñπÊ≥ï2ÔºöÊØîÂ∞ç URL ÁöÑÊúÄÂæåÂÖ©ÊÆµ (‰æãÂ¶Ç /blog/ÊñáÁ´†Âêç/)
            const getLastTwoSegments = (path) => {
                const parts = path
                    .replace(/\/index\.html?$/, '')
                    .replace(/\/+$/, '')
                    .split('/')
                    .filter(Boolean);
                return parts.slice(-2).join('/');
            };

            const pageLast2 = getLastTwoSegments(normPage);
            const currLast2 = getLastTwoSegments(normCurrent);

            if (pageLast2 && currLast2 && pageLast2 === currLast2 && pageLast2.length > 5) {
                return true;
            }

            // ÊñπÊ≥ï3ÔºöÂèñÊúÄÂæåÊúâÊÑèÁæ©ÁöÑ segment (slug)
            const getSlug = (path) => {
                const parts = path
                    .replace(/\/index\.html?$/, '')
                    .replace(/\/+$/, '')
                    .split('/')
                    .filter(Boolean);
                
                return parts[parts.length-1] || '';
            };

            const pageSlug = getSlug(normPage);
            const currSlug = getSlug(normCurrent);

            // slug Ë¶ÅÂ§†Èï∑(>10) ‰∏îÂÆåÂÖ®‰∏ÄËá¥
            if (pageSlug && currSlug && pageSlug === currSlug && pageSlug.length > 10) {
                return true;
            }

            return false;
        };

        const toArray = (val) => {
            if (!val) return [];
            if (Array.isArray(val)) return val;
            
            // Â¶ÇÊûúÊòØÂ≠ó‰∏≤,ÂòóË©¶Ëß£Êûê JSON
            if (typeof val === 'string') {
                try {
                    const parsed = JSON.parse(val);
                    if (Array.isArray(parsed)) return parsed;
                    return [parsed];
                } catch (e) {
                    return [val];
                }
            }
            
            return [];
        };
  
        const ai_kw = toArray({{ with .Params.ai_keywords }}{{ . | jsonify }}{{ else }}null{{ end }});
        const categories = toArray({{ with .Params.categories }}{{ . | jsonify }}{{ else }}null{{ end }});
        const tags = toArray({{ with .Params.tags }}{{ . | jsonify }}{{ else }}null{{ end }});
        const projects = toArray({{ with .Params.projects }}{{ . | jsonify }}{{ else }}null{{ end }});
        const clubhouse = toArray({{ with .Params.clubhouse }}{{ . | jsonify }}{{ else }}null{{ end }});
        const series = toArray({{ with .Params.series }}{{ . | jsonify }}{{ else }}null{{ end }});
        const topics = toArray({{ with .Params.topics }}{{ . | jsonify }}{{ else }}null{{ end }});
        const highlights = toArray({{ with .Params.highlights }}{{ . | jsonify }}{{ else }}null{{ end }});
        
        console.log("üîë AI Keywords:", ai_kw);
        console.log("üìÇ Áï∂ÂâçËª∏:", { categories, tags, projects, clubhouse, series, topics, highlights });
  
        try {
            if (typeof pagefind === 'undefined') {
                window.pagefind = await import("/pagefind/pagefind.js");
            }
            
            // üé≤ ÁîüÊàêÈö®Ê©üÁ®ÆÂ≠ê(Âü∫ÊñºÁï∂Ââç URL)
            const generateSeed = (url) => {
                let hash = 0;
                for (let i = 0; i < url.length; i++) {
                    hash = ((hash << 5) - hash) + url.charCodeAt(i);
                    hash = hash & hash;
                }
                return hash;
            };
            
            const seed = generateSeed(currentNormalizedUrl);
            console.log("üé≤ Èö®Ê©üÁ®ÆÂ≠ê:", seed);
            
            let results = [];
            
            // üìç Â§öÈáçÊêúÂ∞ãÁ≠ñÁï•
            console.log("\nüîç ÈñãÂßãÂ§öÈáçÊêúÂ∞ãÁ≠ñÁï•...");
            
            const allCandidates = new Map(); // Áî® Map ÂéªÈáç,key ÊòØ URL
            
            // üéØ ÊêúÂ∞ã 1: AI Keywords (20 ÁØá)
            if (ai_kw.length > 0) {
                console.log("\nüìå ÊêúÂ∞ã 1: AI Keywords");
                try {
                    const search = await window.pagefind.search(ai_kw.join(" "));
                    const data = await Promise.all(search.results.slice(0, 20).map(r => r.data()));
                    
                    console.log(`  ‚úÖ ÊâæÂà∞ ${data.length} ÁØá`);
                    
                    data.forEach(page => {
                        if (isCurrentPage(page.url)) {
                            console.log(`  üö´ ÊéíÈô§Ëá™Â∑± (AI Keywords): ${page.meta.title.substring(0, 30)}...`);
                            return;
                        }
                        const normUrl = normalizeUrl(page.url);
                        if (!allCandidates.has(normUrl)) {
                            allCandidates.set(normUrl, page);
                        }
                    });
                } catch (err) {
                    console.error("  ‚ùå AI Keywords ÊêúÂ∞ãÂ§±Êïó:", err);
                }
            }
            
            // üéØ ÊêúÂ∞ã 2: Category (10 ÁØá)
            if (categories.length > 0) {
                console.log("\nüìå ÊêúÂ∞ã 2: Category");
                try {
                    const search = await window.pagefind.search(categories.join(" "));
                    const data = await Promise.all(search.results.slice(0, 10).map(r => r.data()));
                    
                    console.log(`  ‚úÖ ÊâæÂà∞ ${data.length} ÁØá`);
                    
                    data.forEach(page => {
                        if (isCurrentPage(page.url)) {
                            console.log(`  üö´ ÊéíÈô§Ëá™Â∑± (Category): ${page.meta.title.substring(0, 30)}...`);
                            return;
                        }
                        const normUrl = normalizeUrl(page.url);
                        if (!allCandidates.has(normUrl)) {
                            allCandidates.set(normUrl, page);
                        }
                    });
                } catch (err) {
                    console.error("  ‚ùå Category ÊêúÂ∞ãÂ§±Êïó:", err);
                }
            }
            
            // üéØ ÊêúÂ∞ã 3: Projects/Clubhouse/Series (Â¶ÇÊûúÊúâÁöÑË©±,ÂêÑ 5 ÁØá)
            const axisSearches = [
                { name: 'Projects', terms: projects, limit: 5 },
                { name: 'Clubhouse', terms: clubhouse, limit: 5 },
                { name: 'Series', terms: series, limit: 5 },
                { name: 'Topics', terms: topics, limit: 5 }
            ];
            
            for (const axis of axisSearches) {
                if (axis.terms.length > 0) {
                    console.log(`\nüìå ÊêúÂ∞ã: ${axis.name}`);
                    try {
                        const search = await window.pagefind.search(axis.terms.join(" "));
                        const data = await Promise.all(search.results.slice(0, axis.limit).map(r => r.data()));
                        
                        console.log(`  ‚úÖ ÊâæÂà∞ ${data.length} ÁØá`);
                        
                        data.forEach(page => {
                            if (isCurrentPage(page.url)) {
                                console.log(`  üö´ ÊéíÈô§Ëá™Â∑± (${axis.name}): ${page.meta.title.substring(0, 30)}...`);
                                return;
                            }
                            const normUrl = normalizeUrl(page.url);
                            if (!allCandidates.has(normUrl)) {
                                allCandidates.set(normUrl, page);
                            }
                        });
                    } catch (err) {
                        console.error(`  ‚ùå ${axis.name} ÊêúÂ∞ãÂ§±Êïó:`, err);
                    }
                }
            }
            
            console.log(`\n‚úÖ Âêà‰ΩµÂæåÂÖ±Êúâ ${allCandidates.size} ÁØáÂÄôÈÅ∏ÊñáÁ´†`);
            
            if (allCandidates.size > 0) {
                const candidateArray = Array.from(allCandidates.values());
                
                // üéØ Ë®àÁÆóÊØèÁØáÊñáÁ´†ÁöÑÊ¨äÈáç
                const weighted = candidateArray.map((page, index) => {
                    // Âü∫Á§éÊ¨äÈáç: ÂæûÊêúÂ∞ãÁµêÊûúÈ†ÜÂ∫èÊ±∫ÂÆö
                    let weight = Math.max(5, 20 - index);
                    let boostReason = [];
                    
                    const pageContent = JSON.stringify(page).toLowerCase();
                    
                    // Ê™¢Êü•ÊòØÂê¶ÊúâÂÖ±ÂêåÁöÑËª∏Ê®ôÁ±§
                    const checkAxis = (axisTags, axisName) => {
                        if (axisTags.length > 0) {
                            const hasMatch = axisTags.some(tag => {
                                const tagLower = tag.toLowerCase();
                                return pageContent.includes(tagLower);
                            });
                            if (hasMatch) {
                                boostReason.push(`Âêå ${axisName}`);
                                return true;
                            }
                        }
                        return false;
                    };
                    
                    const hasCommonAxis = 
                        checkAxis(categories, 'category') ||
                        checkAxis(tags, 'tag') ||
                        checkAxis(projects, 'project') ||
                        checkAxis(clubhouse, 'clubhouse') ||
                        checkAxis(series, 'series') ||
                        checkAxis(topics, 'topics') ||
                        checkAxis(highlights, 'highlights');
                    
                    // Ê™¢Êü• AI Keywords Áõ∏‰ººÂ∫¶
                    let pageKeywords = [];
                    try {
                        const filtersStr = JSON.stringify(page.filters || {});
                        const metaStr = JSON.stringify(page.meta || {});
                        const combinedStr = filtersStr + metaStr;
                        
                        const keywordMatch = combinedStr.match(/\["[^"]+(?:","[^"]+)*"\]/g);
                        if (keywordMatch) {
                            try {
                                pageKeywords = JSON.parse(keywordMatch[0]);
                            } catch (e) {}
                        }
                    } catch (e) {}
                    
                    // Ë®àÁÆó AI Keywords ÈáçÁñäÊï∏Èáè
                    let keywordOverlap = 0;
                    if (ai_kw.length > 0 && pageKeywords.length > 0) {
                        const currentKeywords = ai_kw.map(k => k.toLowerCase());
                        keywordOverlap = pageKeywords.filter(pk => 
                            currentKeywords.some(ck => 
                                ck.includes(pk.toLowerCase()) || pk.toLowerCase().includes(ck)
                            )
                        ).length;
                        
                        if (keywordOverlap >= 2) {
                            boostReason.push(`${keywordOverlap}ÂÄãÂÖ±ÂêåÈóúÈçµÂ≠ó`);
                            weight *= 1.5;
                        } else if (keywordOverlap === 1) {
                            boostReason.push(`1ÂÄãÂÖ±ÂêåÈóúÈçµÂ≠ó`);
                            weight *= 1.2;
                        }
                    }
                    
                    // ÂêåËª∏ÊñáÁ´†Ê¨äÈáçÂä†ÂÄç
                    if (hasCommonAxis) {
                        weight *= 2;
                    }
                    
                    // È°ØÁ§∫Âä†ÊàêÂéüÂõ†
                    if (boostReason.length > 0) {
                        console.log(`    üîñ ${page.meta.title.substring(0, 35)}... (Ê¨äÈáç ${weight.toFixed(1)}: ${boostReason.join(', ')})`);
                    }
                    
                    return { page, weight };
                });
                
                // üîí Á¨¨‰∫åÈáçÈò≤Ë≠∑:ÈÅéÊøæÊéâÁï∂ÂâçÊñáÁ´†
                const filteredWeighted = weighted.filter(item => {
                    if (isCurrentPage(item.page.url)) {
                        console.log(`\n  ‚ö†Ô∏è Á¨¨‰∫åÈáçÈò≤Ë≠∑ÊéíÈô§Ëá™Â∑±: ${item.page.meta.title.substring(0, 40)}...`);
                        return false;
                    }
                    return true;
                });
                
                console.log(`  ‚úÖ ÊéíÈô§ÂæåÂâ© ${filteredWeighted.length} ÁØáÂÄôÈÅ∏`);
                
                console.log("\n  üìä Ê¨äÈáçÂàÜ‰Ωà (Ââç 10 Âêç):");
                filteredWeighted
                    .sort((a, b) => b.weight - a.weight)
                    .slice(0, 10)
                    .forEach((item, i) => {
                        console.log(`    ${i + 1}. Ê¨äÈáç ${item.weight.toFixed(1)}: ${item.page.meta.title.substring(0, 40)}...`);
                    });
                
                // üé≤ ÈÅ∏ÊìáÊé®Ëñ¶ÊñáÁ´†
                const selectRecommendations = (items, count, seed) => {
                    if (items.length === 0) {
                        console.log("  ‚ö†Ô∏è Ê≤íÊúâÂèØÊé®Ëñ¶ÁöÑÊñáÁ´†");
                        return [];
                    }
                    
                    const selected = [];
                    const remaining = [...items];
                    
                    // Á¨¨ 1 ÁØá:ÈÅ∏Ê¨äÈáçÊúÄÈ´òÁöÑ
                    remaining.sort((a, b) => b.weight - a.weight);
                    selected.push(remaining[0].page);
                    remaining.splice(0, 1);
                    
                    console.log(`  üèÜ Á¨¨ 1 ÁØá(ÊúÄÈ´òÊ¨äÈáç): ${selected[0].meta.title.substring(0, 40)}...`);
                    
                    // Á¨¨ 2-3 ÁØá:Âä†Ê¨äÈö®Ê©üÈÅ∏Êìá
                    if (remaining.length > 0) {
                        let currentSeed = seed;
                        const random = () => {
                            currentSeed = (currentSeed * 9301 + 49297) % 233280;
                            return currentSeed / 233280;
                        };
                        
                        const remainingCount = Math.min(count - 1, remaining.length);
                        
                        for (let i = 0; i < remainingCount; i++) {
                            const totalWeight = remaining.reduce((sum, item) => sum + item.weight, 0);
                            let rand = random() * totalWeight;
                            
                            let selectedIndex = 0;
                            for (let j = 0; j < remaining.length; j++) {
                                rand -= remaining[j].weight;
                                if (rand <= 0) {
                                    selectedIndex = j;
                                    break;
                                }
                            }
                            
                            selected.push(remaining[selectedIndex].page);
                            console.log(`  üé≤ Á¨¨ ${selected.length} ÁØá(Âä†Ê¨äÈö®Ê©ü): ${remaining[selectedIndex].page.meta.title.substring(0, 40)}...`);
                            remaining.splice(selectedIndex, 1);
                        }
                    }
                    
                    return selected;
                };
                
                results = selectRecommendations(filteredWeighted, 3, seed);
                
                console.log(`\n  ‚úÖ ÈÅ∏Âá∫ ${results.length} ÁØáÊé®Ëñ¶ (Á¨¨1ÁØá=ÊúÄÈ´òÊ¨äÈáç, Á¨¨2-3ÁØá=Âä†Ê¨äÈö®Ê©ü)`);
            }
            
            // üìç ‰øùÂ∫ïÊ©üÂà∂
            if (results.length < 3) {
                console.log("\nüìç ‰øùÂ∫ïÊ©üÂà∂:Ë£úÂÖÖÊñáÁ´†");
                try {
                    const allSite = await window.pagefind.search("");
                    const fallback = await Promise.all(allSite.results.slice(0, 30).map(r => r.data()));
                    
                    const existingUrls = new Set(results.map(r => normalizeUrl(r.url)));
                    const filtered = fallback.filter(page => {
                        return !isCurrentPage(page.url) && !existingUrls.has(normalizeUrl(page.url));
                    });
                    
                    let currentSeed = seed;
                    const random = () => {
                        currentSeed = (currentSeed * 9301 + 49297) % 233280;
                        return currentSeed / 233280;
                    };
                    
                    const shuffled = filtered.sort(() => random() - 0.5);
                    const needed = 3 - results.length;
                    const toAdd = shuffled.slice(0, needed);
                    results.push(...toAdd);
                    
                    console.log(`  ‚úÖ Ë£úÂÖÖ ${toAdd.length} ÁØá`);
                } catch (err) {
                    console.error("  ‚ùå ‰øùÂ∫ïÊ©üÂà∂Â§±Êïó:", err);
                }
            }
  
            // üîí Á¨¨‰∏âÈáçÈò≤Ë≠∑:ÊúÄÁµÇÊ™¢Êü•
            results = results.filter(page => {
                if (isCurrentPage(page.url)) {
                    console.warn(`‚ö†Ô∏è Á¨¨‰∏âÈáçÈò≤Ë≠∑ÊéíÈô§Ëá™Â∑±: ${page.meta.title}`);
                    return false;
                }
                return true;
            });

            console.log("\n‚úÖ ÊúÄÁµÇÊé®Ëñ¶:");
            results.forEach((r, i) => {
                console.log(`  ${i + 1}. ${r.meta.title.substring(0, 40)}...`);
            });
  
            // Ê∏ÖÁêÜÊ®ôÈ°å
            const cleanTitle = (title) => {
                if (!title) return '';
                let cleaned = title;
                const sitePatterns = [
                    /[\sÔΩú\|\-‚Äì‚Äî]*ËÅÜËÅΩÁöÑÊ≤≥ÊµÅ(?:ÔΩúÈñ±ËÆÄ„ÉªÊõ∏ÂØ´„ÉªÂøÉÁêÜ„ÉªÈõªÂΩ±)?\s*$/i,
                    /[\sÔΩú\|\-‚Äì‚Äî]*Èñ±ËÆÄ„ÉªÊõ∏ÂØ´„ÉªÂøÉÁêÜ„ÉªÈõªÂΩ±\s*$/i,
                    /[\sÔΩú\|\-‚Äì‚Äî]*ËÅÜËÅΩÁöÑÊ≤≥ÊµÅ\s*$/i
                ];
                for (const pattern of sitePatterns) {
                    cleaned = cleaned.replace(pattern, '').trim();
                }
                cleaned = cleaned.replace(/[\sÔΩú\|\-‚Äì‚Äî,:,Ôºõ]+$/, '').trim();
                return cleaned;
            };
  
            // Ê∏≤Êüì
            if (results.length > 0) {
                results.forEach(page => {
                    const card = document.createElement('a');
                    card.href = page.url;
                    card.style.cssText = `
                        display: block;
                        padding: 10px 12px;
                        background: #fff;
                        border: 1px solid #e8e8e8;
                        border-radius: 6px;
                        text-decoration: none;
                        color: #444;
                        font-size: 0.85rem;
                        line-height: 1.4;
                        box-shadow: 0 1px 3px rgba(0,0,0,0.05);
                        transition: all 0.2s ease;
                    `;
                    card.onmouseenter = () => {
                        card.style.transform = "translateY(-2px)";
                        card.style.boxShadow = "0 3px 8px rgba(0,0,0,0.1)";
                        card.style.borderColor = "#d0d0d0";
                    };
                    card.onmouseleave = () => {
                        card.style.transform = "translateY(0)";
                        card.style.boxShadow = "0 1px 3px rgba(0,0,0,0.05)";
                        card.style.borderColor = "#e8e8e8";
                    };
                    
                    const cleanedTitle = cleanTitle(page.meta.title);
                    card.innerHTML = `<strong style="font-weight: 500;">${cleanedTitle}</strong>`;
                    list.appendChild(card);
                });
                section.style.display = 'block';
            }
        } catch (e) { 
            console.error("‚ùå Pagefind ÈåØË™§:", e);
        }
    });
  </script>
