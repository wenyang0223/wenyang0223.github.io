<section id="related-posts-section" class="related-wrapper" style="display:none; margin: 2rem 0; padding: 1.5rem; background: #fcfcfc; border-radius: 12px; border: 1px solid #eee;">
  <h3 style="margin-top:0; font-size: 1.1rem; color: #444;">ğŸ’¡ å»¶ä¼¸é–±è®€</h3>
  <div id="related-posts-list" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-top: 1rem;"></div>
</section>

<script>
  document.addEventListener('DOMContentLoaded', async () => {
      const list = document.getElementById('related-posts-list');
      const section = document.getElementById('related-posts-section');
      const currentUrl = window.location.pathname;

      // 1. å–å¾—æœå°‹é—œéµå­—
      const ai_kw = {{ with .Params.ai_keywords }}{{ . | jsonify }}{{ else }}[]{{ end }};
      const cats = {{ with .Params.categories }}{{ . | jsonify }}{{ else }}[]{{ end }};
      const searchTerms = [...ai_kw, ...cats].join(" ");

      console.log("ğŸ” æœå°‹é—œéµå­—:", searchTerms); // åµéŒ¯ç”¨

      try {
          if (typeof pagefind === 'undefined') {
              console.log("ğŸ“¦ è¼‰å…¥ Pagefind...");
              window.pagefind = await import("/pagefind/pagefind.js");
          }

          // 2. åŸ·è¡Œæœå°‹
          const search = await window.pagefind.search(searchTerms);
          console.log("ğŸ“Š æœå°‹çµæœæ•¸é‡:", search.results.length);

          let results = await Promise.all(
              search.results
                  .filter(r => !r.url.includes(currentUrl))
                  .slice(0, 3)
                  .map(r => r.data())
          );

          // 3. ä¿åº•æ©Ÿåˆ¶
          if (results.length < 2) {
              console.log("âš ï¸ ç›¸é—œæ–‡ç« ä¸è¶³ï¼Œä½¿ç”¨ä¿åº•æ©Ÿåˆ¶");
              const allSite = await window.pagefind.search("");
              const fallback = await Promise.all(
                  allSite.results
                      .filter(r => !r.url.includes(currentUrl))
                      .slice(0, 3)
                      .map(r => r.data())
              );
              results = fallback;
          }

          console.log("âœ… æœ€çµ‚é¡¯ç¤º:", results.length, "ç¯‡");

          // 4. æ¸²æŸ“
          if (results.length > 0) {
              results.forEach(page => {
                  const card = document.createElement('a');
                  card.href = page.url;
                  card.style.cssText = "display:block; padding:12px; background:#fff; border:1px solid #eee; border-radius:8px; text-decoration:none; color:#333; font-size:0.95rem; box-shadow: 0 2px 5px rgba(0,0,0,0.02); transition: transform 0.2s;";
                  card.onmouseenter = () => card.style.transform = "translateY(-2px)";
                  card.onmouseleave = () => card.style.transform = "translateY(0)";
                  card.innerHTML = `<strong>${page.meta.title}</strong>`;
                  list.appendChild(card);
              });
              section.style.display = 'block';
          } else {
              console.log("âŒ æ²’æœ‰å¯é¡¯ç¤ºçš„æ–‡ç« ");
          }
      } catch (e) { 
          console.error("âŒ Pagefind éŒ¯èª¤:", e);
      }
  });
</script>