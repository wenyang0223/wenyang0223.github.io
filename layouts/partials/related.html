<script>
  document.addEventListener('DOMContentLoaded', async () => {
      const list = document.getElementById('related-posts-list');
      const section = document.getElementById('related-posts-section');
      const currentUrl = window.location.pathname;

      // 1. 取得搜尋關鍵字
      const ai_kw = {{ with .Params.ai_keywords }}{{ . | jsonify }}{{ else }}[]{{ end }};
      const cats = {{ with .Params.categories }}{{ . | jsonify }}{{ else }}[]{{ end }};
      const searchTerms = [...ai_kw, ...cats].join(" ");

      try {
          if (typeof pagefind === 'undefined') {
              window.pagefind = await import("/pagefind/pagefind.js");
          }

          // 2. 執行搜尋
          const search = await window.pagefind.search(searchTerms);
          
          // 修正點：先執行 .slice 取前幾名，再 map 成 data，最後才過濾
          // 這樣可以確保我們是在有資料的情況下進行 includes 檢查
          const results = await Promise.all(
              search.results.slice(0, 5).map(r => r.data())
          );

          // 3. 過濾掉自己，並取前 3 名
          let filteredResults = results.filter(page => {
              // 增加安全檢查，確保 page 和 page.url 存在
              return page && page.url && !page.url.includes(currentUrl);
          }).slice(0, 3);

          // 4. 【保底機制】如果相關度結果不足，抓全站最新
          if (filteredResults.length < 1) {
              const allSite = await window.pagefind.search(""); 
              const fallback = await Promise.all(
                  allSite.results.slice(0, 4).map(r => r.data())
              );
              filteredResults = fallback.filter(page => 
                  page && page.url && !page.url.includes(currentUrl)
              ).slice(0, 3);
          }

          // 5. 渲染
          if (filteredResults.length > 0) {
              list.innerHTML = ''; // 清空內容
              filteredResults.forEach(page => {
                  const card = document.createElement('a');
                  card.href = page.url;
                  card.style.cssText = "display:block; padding:12px; background:#fff; border:1px solid #eee; border-radius:8px; text-decoration:none; color:#333; font-size:0.95rem; box-shadow: 0 2px 5px rgba(0,0,0,0.02);";
                  card.innerHTML = `<strong>${page.meta.title}</strong>`;
                  list.appendChild(card);
              });
              section.style.display = 'block';
          }
      } catch (e) { 
          console.error("Pagefind error:", e); 
      }
  });
</script>