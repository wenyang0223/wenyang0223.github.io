<section id="related-posts-section" class="related-wrapper" style="display:none; margin: 2rem 0; padding: 1.2rem; background: #f8f9fa; border-radius: 10px; border: 1px solid #e0e0e0;">
    <h3 style="margin-top:0; margin-bottom: 0.8rem; font-size: 0.95rem; color: #555; font-weight: 600;">ğŸ’¡ å»¶ä¼¸é–±è®€</h3>
    <div id="related-posts-list" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 0.8rem;"></div>
  </section>
  
  <script>
    document.addEventListener('DOMContentLoaded', async () => {
        const list = document.getElementById('related-posts-list');
        const section = document.getElementById('related-posts-section');
        const currentUrl = window.location.pathname;
        
        // è¦ç¯„åŒ– URL(ç§»é™¤çµå°¾æ–œç·š,çµ±ä¸€æ¯”å°)
        const normalizeUrl = (url) => {
            return url.replace(/\/$/, '').toLowerCase();
        };
        
        const currentNormalizedUrl = normalizeUrl(currentUrl);
        
        console.log("ğŸ“ ç•¶å‰é é¢ URL:", currentUrl);
  
        const toArray = (val) => {
            if (!val) return [];
            if (Array.isArray(val)) return val;
            if (typeof val === 'string') return [val];
            return [];
        };
  
        const ai_kw = toArray({{ with .Params.ai_keywords }}{{ . | jsonify }}{{ else }}null{{ end }});
        const projects = toArray({{ with .Params.projects }}{{ . | jsonify }}{{ else }}null{{ end }});
        const clubhouse = toArray({{ with .Params.clubhouse }}{{ . | jsonify }}{{ else }}null{{ end }});
        const series = toArray({{ with .Params.series }}{{ . | jsonify }}{{ else }}null{{ end }});
        const topics = toArray({{ with .Params.topics }}{{ . | jsonify }}{{ else }}null{{ end }});
        
        console.log("ğŸ”‘ AI Keywords:", ai_kw);
        console.log("ğŸ“‚ ç•¶å‰è»¸:", { projects, clubhouse, series, topics });
  
        try {
            if (typeof pagefind === 'undefined') {
                window.pagefind = await import("/pagefind/pagefind.js");
            }
            
            // ğŸ² ç”Ÿæˆéš¨æ©Ÿç¨®å­(åŸºæ–¼ç•¶å‰ URL)
            const generateSeed = (url) => {
                let hash = 0;
                for (let i = 0; i < url.length; i++) {
                    hash = ((hash << 5) - hash) + url.charCodeAt(i);
                    hash = hash & hash;
                }
                return hash;
            };
            
            // ğŸ”€ å¯é æ¸¬çš„éš¨æ©Ÿæ’åº
            const seededShuffle = (array, seed) => {
                const rng = (s) => {
                    s = Math.sin(s) * 10000;
                    return s - Math.floor(s);
                };
                
                const shuffled = [...array];
                for (let i = shuffled.length - 1; i > 0; i--) {
                    const j = Math.floor(rng(seed + i) * (i + 1));
                    [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
                }
                return shuffled;
            };
            
            const seed = generateSeed(currentNormalizedUrl);
            console.log("ğŸ² éš¨æ©Ÿç¨®å­:", seed);
            
            let results = [];
            
            // ğŸ“ æ–¹æ¡ˆ B+: ç”¨ AI Keywords æœå°‹ 10 ç¯‡,åŠ æ¬Šéš¨æ©Ÿæ¨è–¦ 3 ç¯‡
            if (ai_kw.length > 0) {
                console.log("\nğŸ” æœå°‹ AI Keywords ç›¸é—œæ–‡ç« ...");
                
                try {
                    const search = await window.pagefind.search(ai_kw.join(" "));
                    const data = await Promise.all(search.results.slice(0, 10).map(r => r.data()));
                    
                    console.log(`  âœ… æ‰¾åˆ° ${data.length} ç¯‡æ–‡ç« `);
                    
                    // éæ¿¾æ‰ç•¶å‰æ–‡ç« 
                    const filtered = data.filter(page => {
                        const pageNormalizedUrl = normalizeUrl(page.url);
                        return pageNormalizedUrl !== currentNormalizedUrl;
                    });
                    
                    console.log(`  âœ… éæ¿¾å¾Œå‰© ${filtered.length} ç¯‡(æ’é™¤è‡ªå·±)`);
                    
                    // ğŸ¯ è¨ˆç®—æ¯ç¯‡æ–‡ç« çš„æ¬Šé‡
                    const weighted = filtered.map((page, index) => {
                        // åŸºç¤æ¬Šé‡:Pagefind æ’åè¶Šå‰é¢æ¬Šé‡è¶Šé«˜
                        // ç¬¬ 1 ç¯‡æ¬Šé‡ 10, ç¬¬ 2 ç¯‡æ¬Šé‡ 9... ç¬¬ 10 ç¯‡æ¬Šé‡ 1
                        let weight = 10 - index;
                        
                        // æª¢æŸ¥æ˜¯å¦æœ‰å…±åŒçš„è»¸æ¨™ç±¤(projects, clubhouse, series, topics)
                        const pageContent = JSON.stringify(page).toLowerCase();
                        let hasCommonAxis = false;
                        
                        // å¦‚æœæœ‰å…±åŒçš„ project æ¨™ç±¤
                        if (projects.length > 0) {
                            const hasMatch = projects.some(tag => 
                                pageContent.includes(tag.toLowerCase())
                            );
                            if (hasMatch) {
                                hasCommonAxis = true;
                                console.log(`    ğŸ”– åŒ project: ${page.meta.title.substring(0, 30)}...`);
                            }
                        }
                        
                        // å¦‚æœæœ‰å…±åŒçš„ clubhouse æ¨™ç±¤
                        if (clubhouse.length > 0) {
                            const hasMatch = clubhouse.some(tag => 
                                pageContent.includes(tag.toLowerCase())
                            );
                            if (hasMatch) {
                                hasCommonAxis = true;
                                console.log(`    ğŸ”– åŒ clubhouse: ${page.meta.title.substring(0, 30)}...`);
                            }
                        }
                        
                        // å¦‚æœæœ‰å…±åŒçš„ series æ¨™ç±¤
                        if (series.length > 0) {
                            const hasMatch = series.some(tag => 
                                pageContent.includes(tag.toLowerCase())
                            );
                            if (hasMatch) {
                                hasCommonAxis = true;
                                console.log(`    ğŸ”– åŒ series: ${page.meta.title.substring(0, 30)}...`);
                            }
                        }
                        
                        // å¦‚æœæœ‰å…±åŒçš„ topics æ¨™ç±¤
                        if (topics.length > 0) {
                            const hasMatch = topics.some(tag => 
                                pageContent.includes(tag.toLowerCase())
                            );
                            if (hasMatch) {
                                hasCommonAxis = true;
                                console.log(`    ğŸ”– åŒ topics: ${page.meta.title.substring(0, 30)}...`);
                            }
                        }
                        
                        // åŒè»¸æ–‡ç« æ¬Šé‡åŠ å€
                        if (hasCommonAxis) {
                            weight *= 2;
                        }
                        
                        return { page, weight };
                    });
                    
                    console.log("\n  ğŸ“Š æ¬Šé‡åˆ†ä½ˆ:");
                    weighted.forEach((item, i) => {
                        console.log(`    ${i + 1}. æ¬Šé‡ ${item.weight}: ${item.page.meta.title.substring(0, 30)}...`);
                    });
                    
                    // ğŸ² åŠ æ¬Šéš¨æ©Ÿé¸å– 3 ç¯‡
                    const weightedRandomSelect = (items, count, seed) => {
                        const selected = [];
                        const remaining = [...items];
                        
                        // ç°¡å–®çš„å½éš¨æ©Ÿç”Ÿæˆå™¨
                        let currentSeed = seed;
                        const random = () => {
                            currentSeed = (currentSeed * 9301 + 49297) % 233280;
                            return currentSeed / 233280;
                        };
                        
                        for (let i = 0; i < count && remaining.length > 0; i++) {
                            // è¨ˆç®—ç¸½æ¬Šé‡
                            const totalWeight = remaining.reduce((sum, item) => sum + item.weight, 0);
                            
                            // éš¨æ©Ÿé¸ä¸€å€‹æ•¸å­—
                            let rand = random() * totalWeight;
                            
                            // æ‰¾åˆ°å°æ‡‰çš„é …ç›®
                            let selectedIndex = 0;
                            for (let j = 0; j < remaining.length; j++) {
                                rand -= remaining[j].weight;
                                if (rand <= 0) {
                                    selectedIndex = j;
                                    break;
                                }
                            }
                            
                            // é¸ä¸­ä¸¦ç§»é™¤
                            selected.push(remaining[selectedIndex].page);
                            remaining.splice(selectedIndex, 1);
                        }
                        
                        return selected;
                    };
                    
                    results = weightedRandomSelect(weighted, 3, seed);
                    
                    console.log(`\n  âœ… åŠ æ¬Šéš¨æ©Ÿé¸å‡º ${results.length} ç¯‡æ¨è–¦`);
                    
                } catch (err) {
                    console.error("  âŒ AI Keywords æœå°‹å¤±æ•—:", err);
                }
            }
            
            // ğŸ“ ä¿åº•æ©Ÿåˆ¶:å¦‚æœ AI Keywords æ²’æœ‰æˆ–çµæœä¸è¶³
            if (results.length < 3) {
                console.log("\nğŸ“ ä¿åº•æ©Ÿåˆ¶:è£œå……æ–‡ç« ");
                try {
                    const allSite = await window.pagefind.search("");
                    const fallback = await Promise.all(allSite.results.slice(0, 30).map(r => r.data()));
                    
                    // éæ¿¾æ‰ç•¶å‰æ–‡ç« å’Œå·²æ¨è–¦çš„
                    const existingUrls = new Set(results.map(r => normalizeUrl(r.url)));
                    const filtered = fallback.filter(page => {
                        const pageUrl = normalizeUrl(page.url);
                        return pageUrl !== currentNormalizedUrl && !existingUrls.has(pageUrl);
                    });
                    
                    // ç”¨ç¨®å­æ‰“äº‚
                    const shuffled = seededShuffle(filtered, seed);
                    
                    const needed = 3 - results.length;
                    const toAdd = shuffled.slice(0, needed);
                    results.push(...toAdd);
                    
                    console.log(`  âœ… è£œå…… ${toAdd.length} ç¯‡`);
                } catch (err) {
                    console.error("  âŒ ä¿åº•æ©Ÿåˆ¶å¤±æ•—:", err);
                }
            }
  
            console.log("\nâœ… æœ€çµ‚æ¨è–¦:");
            results.forEach((r, i) => {
                console.log(`  ${i + 1}. ${r.meta.title.substring(0, 40)}...`);
            });
  
            // æ¸…ç†æ¨™é¡Œ
            const cleanTitle = (title) => {
                if (!title) return '';

                let cleaned = title;

                // å®šç¾©è¦ç§»é™¤çš„å¾Œç¶´æ¨¡å¼(å¯æ“´å……)
                const sitePatterns = [
                    /[\sï½œ\|\-â€“â€”]*è†è½çš„æ²³æµ(?:ï½œé–±è®€ãƒ»æ›¸å¯«ãƒ»å¿ƒç†ãƒ»é›»å½±)?\s*$/i,
                    /[\sï½œ\|\-â€“â€”]*é–±è®€ãƒ»æ›¸å¯«ãƒ»å¿ƒç†ãƒ»é›»å½±\s*$/i,
                    /[\sï½œ\|\-â€“â€”]*è†è½çš„æ²³æµ\s*$/i
                ];

                // ç§»é™¤å¾Œç¶´
                for (const pattern of sitePatterns) {
                    cleaned = cleaned.replace(pattern, '').trim();
                }

                // å¦‚æœé‚„æœ‰æ®˜é¤˜çš„åˆ†éš”ç¬¦åœ¨çµå°¾,ä¹Ÿæ¸…æ‰
                cleaned = cleaned.replace(/[\sï½œ\|\-â€“â€”,:,ï¼›]+$/, '').trim();

                return cleaned;
            };
  
            // æ¸²æŸ“
            if (results.length > 0) {
                results.forEach(page => {
                    const card = document.createElement('a');
                    card.href = page.url;
                    card.style.cssText = `
                        display: block;
                        padding: 10px 12px;
                        background: #fff;
                        border: 1px solid #e8e8e8;
                        border-radius: 6px;
                        text-decoration: none;
                        color: #444;
                        font-size: 0.85rem;
                        line-height: 1.4;
                        box-shadow: 0 1px 3px rgba(0,0,0,0.05);
                        transition: all 0.2s ease;
                    `;
                    card.onmouseenter = () => {
                        card.style.transform = "translateY(-2px)";
                        card.style.boxShadow = "0 3px 8px rgba(0,0,0,0.1)";
                        card.style.borderColor = "#d0d0d0";
                    };
                    card.onmouseleave = () => {
                        card.style.transform = "translateY(0)";
                        card.style.boxShadow = "0 1px 3px rgba(0,0,0,0.05)";
                        card.style.borderColor = "#e8e8e8";
                    };
                    
                    const cleanedTitle = cleanTitle(page.meta.title);
                    card.innerHTML = `<strong style="font-weight: 500;">${cleanedTitle}</strong>`;
                    list.appendChild(card);
                });
                section.style.display = 'block';
            }
        } catch (e) { 
            console.error("âŒ Pagefind éŒ¯èª¤:", e);
        }
    });
  </script>
